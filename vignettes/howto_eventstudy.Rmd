---
title: "Howto: An Example"
author: "Dr. Simon MÃ¼ller"
date: "`r Sys.Date()`"
output:
  rmdformats::html_clean:
    self_contained: true
    thumbnails: true
    lightbox: true
    gallery: false
    highlight: tango
    css: kable.css
vignette: >
  %\VignetteIndexEntry{Prepare Event Study}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Overview

```{r, message=F, echo=T}
library(tidyquant)
library(dplyr)
library(readr)
```

# Data Preparation

We use the package `tidyquant` to fetch the automotive stock data from Yahoo Finance. 
```{r}
# Firm Data
firmSymbols <- c("VOW.DE", "NSU.DE", "PAH3.DE", "BMW.DE", "DAI.DE")
firmNames <- c("VW preferred", "Audi", "Porsche Automobil Hld", "BMW", "Daimler")
startDate <- "2014-05-01"
endDate <- "2015-12-31"
firmSymbols %>% 
  tidyquant::tq_get(from = startDate, to = endDate) %>% 
  dplyr::mutate(date = format(date, "%d.%m.%Y")) -> firmData
```

```{r}
# Index Data
indexSymbol <- c("^GDAXI")
indexName <- c("DAX")
indexSymbol %>% 
  tidyquant::tq_get(from = startDate, to = endDate) %>% 
  dplyr::mutate(date = format(date, "%d.%m.%Y")) -> indexData
indexData$symbol <- "DAX"
```

Now, after we have fetched all the data, we prepare the data files for the API call.
```{r}
# Price files for firms and market
firmData %>% 
  dplyr::select(symbol, date, adjusted) %>% 
  readr::write_delim(path      = "02_firmDataPrice.csv", 
                     delim     = ";", 
                     col_names = F)

indexData %>% 
  dplyr::select(symbol, date, adjusted) %>% 
  readr::write_delim(path      = "03_marketDataPrice.csv", 
                     delim     = ";", 
                     col_names = F)

# Volume files for firms and market
firmData %>% 
  dplyr::select(symbol, date, volume) %>% 
  readr::write_delim(path      = "02_firmDataVolume.csv", 
                     delim     = ";", 
                     col_names = F)

indexData %>% 
  dplyr::select(symbol, date, volume) %>% 
  readr::write_delim(path      = "03_marketDataVolume.csv", 
                     delim     = ";", 
                     col_names = F)
```


```{r}
group <- c(rep("VW Group", 3), rep("Other", 2))
request <- cbind(c(1:5), firmSymbols, rep(indexName, 5), rep("18.09.2015", 5), group, rep(-10, 5), rep(10, 5), rep(-11, 5), rep(250, 5))
request %>% 
  as.data.frame() %>% 
  readr::write_delim("01_requestFile.csv", delim = ";", col_names = F)
```


# Perform Event Studies: Abnromal Return, Volume, and Volatility

## Abnormal Return Event Study

```{r}
key <- "573e58c665fcc08cc6e5a660beaad0cb"

library(EventStudy)
est <- EventStudyAPI$new()
est$authentication(apiKey = key)

# get & set parameters for abnormal return Event Study
# we use a garch model and csv as return
# Attention: fitting a GARCH(1, 1) model is compute intensive
esaParams <- EventStudy::ARCApplicationInput$new()
esaParams$setResultFileType("csv")
esaParams$setBenchmarkModel("garch")

dataFiles <- c("request_file" = "01_requestFile.csv",
               "firm_data"    = "02_firmDataPrice.csv",
               "market_data"  = "03_marketDataPrice.csv")

# check data files, you can do it also in our R6 class
EventStudy::checkFiles(dataFiles)

# now let us perform the Event Study
arEventStudy <- est$performEventStudy(estParams = esaParams, 
                                      dataFiles = dataFiles)
```

## Abnormal Volatility Event Study

```{r}
# est <- EventStudyAPI$new()
# est$authentication(apiKey = key)
# 
# # get & set parameters for abnormal return Event Study
# esaParams <- EventStudy::AVyCApplicationInput$new()
# esaParams$setResultFileType("csv")
# 
# avycEventStudy <- est$performEventStudy(estParams = esaParams, 
#                                         dataFiles = dataFiles)
```

## Abnormal Volume Event Study

```{r}
# est <- EventStudyAPI$new()
# est$authentication(apiKey = key)
# 
# # get & set parameters for abnormal return Event Study
# esaParams <- EventStudy::AVCApplicationInput$new()
# esaParams$setResultFileType("csv")
# 
# avEventStudy <- est$performEventStudy(estParams = esaParams, 
#                       dataFiles = c("request_file" = "01_requestFile.csv",
#                                     "firm_data"    = "02_firmDataVolume.csv",
#                                     "market_data"  = "03_marketDataVolume.csv"))
```

# Plot and Work with the results

```{r}
EventStudy::aarPlot(arEventStudy)
```
```{r}
EventStudy::aarPlot(arEventStudy, cumSum = T)
```
```{r}
EventStudy::arPlot(arEventStudy, facetVar = "Firm", ncol = 3)
```
```{r}
EventStudy::arPlot(arEventStudy)
```